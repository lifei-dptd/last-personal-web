<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç•™è¨€æ¿ - åˆ˜åŠ›è²çš„ä¸ªäººç½‘ç«™</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* ç•™è¨€æ¿ç‰¹æœ‰æ ·å¼ */
        .guestbook-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .guestbook-header {
            text-align: center;
            margin-bottom: 3rem;
            background: linear-gradient(135deg, rgba(74, 144, 226, 0.1), rgba(224, 102, 255, 0.1));
            padding: 2rem;
            border-radius: 15px;
        }
        
        .guestbook-title {
            font-size: 2.5rem;
            color: var(--text-color);
            margin-bottom: 1rem;
        }
        
        .guestbook-subtitle {
            font-size: 1.2rem;
            color: var(--text-light);
            line-height: 1.6;
        }
        
        .guestbook-form {
            background: var(--white);
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            margin-bottom: 3rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-color);
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            font-family: var(--font-family);
            color: var(--text-color);
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }
        
        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .form-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
        }
        
        .btn-submit {
            padding: 0.8rem 2rem;
            border-radius: 30px;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            border: none;
            background-color: var(--primary-color);
            color: var(--white);
            cursor: pointer;
        }
        
        .btn-submit:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--shadow);
        }
        
        .btn-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .character-count {
            font-size: 0.9rem;
            color: var(--text-light);
        }
        
        .guestbook-messages {
            margin-top: 3rem;
        }
        
        .messages-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .messages-title {
            font-size: 1.8rem;
            color: var(--text-color);
        }
        
        .message-count {
            background: rgba(74, 144, 226, 0.1);
            color: var(--primary-color);
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .message-list {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .message-card {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }
        
        .message-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .message-info {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.2rem;
        }
        
        .message-name {
            font-weight: 600;
            color: var(--text-color);
        }
        
        .message-contact {
            font-size: 0.9rem;
            color: var(--text-light);
        }
        
        .message-time {
            font-size: 0.9rem;
            color: var(--text-light);
        }
        
        .message-content {
            color: var(--text-color);
            line-height: 1.6;
            word-break: break-word;
        }
        
        .empty-messages {
            text-align: center;
            padding: 3rem;
            color: var(--text-light);
        }
        
        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--white);
            animation: spin 1s ease-in-out infinite;
            margin-right: 0.5rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .form-message {
            margin-top: 1rem;
            padding: 0.8rem;
            border-radius: 8px;
            font-size: 0.9rem;
            display: none;
        }
        
        .form-message.success {
            background-color: rgba(76, 175, 80, 0.1);
            color: #4CAF50;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }
        
        .form-message.error {
            background-color: rgba(255, 68, 68, 0.1);
            color: #ff4444;
            border: 1px solid rgba(255, 68, 68, 0.3);
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(74, 144, 226, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .guestbook-container {
                padding: 1rem;
            }
            
            .guestbook-title {
                font-size: 2rem;
            }
            
            .form-actions {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
            
            .message-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">åˆ˜åŠ›è²</div>
            <ul class="nav-menu" id="navMenu">
                <li><a href="index.html" class="nav-link">é¦–é¡µ</a></li>
                <li><a href="#about" class="nav-link">å…³äºæˆ‘</a></li>
                <li><a href="#skills" class="nav-link">æŠ€èƒ½åˆ†æ</a></li>
                <li><a href="#timeline" class="nav-link">æ±‚å­¦ç»å†</a></li>
                <li><a href="#hobbies" class="nav-link">å…´è¶£çˆ±å¥½</a></li>
                <li><a href="#gallery" class="nav-link">ç…§ç‰‡å¢™</a></li>
                <li><a href="#contact" class="nav-link">è”ç³»æ–¹å¼</a></li>
                <li><a href="guestbook.html" class="nav-link active">ç•™è¨€æ¿</a></li>
                <li><a href="/login.html" id="loginLink">ç™»å½•</a></li>
            </ul>
            <div class="hamburger" id="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹ -->
    <main>
        <div class="guestbook-container">
            <div class="guestbook-header">
                <h1 class="guestbook-title">è®¿å®¢ç•™è¨€æ¿</h1>
                <p class="guestbook-subtitle">æ„Ÿè°¢æ‚¨çš„è®¿é—®ï¼Œè¯·åœ¨è¿™é‡Œç•™ä¸‹æ‚¨çš„å®è´µæ„è§å’Œå»ºè®®</p>
            </div>
            
            <!-- ç•™è¨€è¡¨å• -->
            <div class="guestbook-form" id="guestbookFormContainer">
                <h2 style="margin-bottom: 1.5rem; color: var(--text-color);">å‘è¡¨ç•™è¨€</h2>
                <form id="messageForm">
                    <div class="form-group">
                        <label for="visitorName">æ‚¨çš„å§“å</label>
                        <input type="text" id="visitorName" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="visitorPhone">è”ç³»ç”µè¯</label>
                        <input type="tel" id="visitorPhone" placeholder="è¯·è¾“å…¥æ‚¨çš„è”ç³»ç”µè¯" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="messageContent">ç•™è¨€å†…å®¹</label>
                        <textarea id="messageContent" placeholder="è¯·è¾“å…¥æ‚¨çš„ç•™è¨€å†…å®¹..." maxlength="500" required></textarea>
                        <div class="character-count">
                            <span id="charCount">0</span> / 500 å­—
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" id="submitBtn" class="btn-submit">å‘å¸ƒç•™è¨€</button>
                        <div id="formMessage" class="form-message"></div>
                    </div>
                </form>
            </div>
            
            <!-- ç•™è¨€åˆ—è¡¨ -->
            <div class="guestbook-messages">
                <div class="messages-header">
                    <h2 class="messages-title">è®¿å®¢ç•™è¨€</h2>
                    <div class="message-count" id="messageCount">å…± 0 æ¡ç•™è¨€</div>
                </div>
                
                <div class="message-list" id="messageList">
                    <!-- ç•™è¨€å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                    <div id="loadingMessages" style="text-align: center; padding: 2rem; color: var(--text-light);">
                        <p>æ­£åœ¨åŠ è½½ç•™è¨€...</p>
                    </div>
                </div>
                
                <div class="empty-messages" id="emptyMessages" style="display: none;">
                    <div class="empty-icon">ğŸ“</div>
                    <p>æš‚æ— ç•™è¨€ï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡ç•™è¨€å§ï¼</p>
                </div>
            </div>
        </div>
    </main>
    
    <!-- åŠ è½½é®ç½© -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-spinner"></div>
    </div>

    <!-- JavaScript -->
    <script>
        // ç®€åŒ–çš„å¯¼èˆªèœå•åˆå§‹åŒ–ï¼Œé¿å…ä¾èµ–script.jsä¸­å¯èƒ½ä¸å­˜åœ¨çš„å‡½æ•°
        function initializeNavigation() {
            const hamburger = document.getElementById('hamburger');
            const navMenu = document.getElementById('navMenu');
            
            if (hamburger && navMenu) {
                hamburger.addEventListener('click', () => {
                    navMenu.classList.toggle('active');
                });
                
                // ç‚¹å‡»å¯¼èˆªé“¾æ¥æ—¶å…³é—­èœå•
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', () => {
                        navMenu.classList.remove('active');
                    });
                });
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', () => {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            checkLoginStatus();
            
            // åˆå§‹åŒ–é¡µé¢
            initializePage();
            
            // åŠ è½½ç•™è¨€
            loadMessages();
        });
        
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkLoginStatus() {
            console.log('æ£€æŸ¥ç™»å½•çŠ¶æ€...');
            const visitorInfo = localStorage.getItem('visitorInfo');
            console.log('è®¿å®¢ä¿¡æ¯:', visitorInfo);
            
            if (!visitorInfo) {
                console.log('æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢');
                // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
                alert('æ‚¨éœ€è¦å…ˆç™»å½•æ‰èƒ½ä½¿ç”¨ç•™è¨€æ¿åŠŸèƒ½');
                window.location.href = '/login.html';
                return;
            }
            
            try {
                const { name, phone } = JSON.parse(visitorInfo);
                console.log('è§£æè®¿å®¢ä¿¡æ¯:', { name, phone });
                
                // è®¾ç½®è®¿å®¢ä¿¡æ¯åˆ°è¡¨å•
                document.getElementById('visitorName').value = name || '';
                document.getElementById('visitorPhone').value = phone || '';
                console.log('è¡¨å•ä¿¡æ¯å·²è®¾ç½®');
            } catch (error) {
                console.error('è·å–è®¿å®¢ä¿¡æ¯å¤±è´¥:', error);
                alert('è·å–è®¿å®¢ä¿¡æ¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•');
                window.location.href = '/login.html';
            }
        }
        
        // åˆå§‹åŒ–é¡µé¢
        function initializePage() {
            // ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
            document.getElementById('messageForm').addEventListener('submit', handleFormSubmit);
            
            // ç»‘å®šæ–‡æœ¬æ¡†å­—æ•°ç»Ÿè®¡
            document.getElementById('messageContent').addEventListener('input', updateCharacterCount);
            
            // åˆå§‹åŒ–å¯¼èˆªèœå•
            initializeNavigation();
        }
        
        // æ›´æ–°å­—æ•°ç»Ÿè®¡
        function updateCharacterCount() {
            const content = document.getElementById('messageContent').value;
            const charCount = content.length;
            document.getElementById('charCount').textContent = charCount;
        }
        
        // å¤„ç†è¡¨å•æäº¤
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            const visitorInfo = localStorage.getItem('visitorInfo');
            if (!visitorInfo) {
                showFormMessage('è¯·å…ˆç™»å½•', 'error');
                return;
            }
            
            const { name, phone } = JSON.parse(visitorInfo);
            const content = document.getElementById('messageContent').value.trim();
            
            if (!content) {
                showFormMessage('è¯·è¾“å…¥ç•™è¨€å†…å®¹', 'error');
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.textContent;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner"></span>æ­£åœ¨å‘å¸ƒ...';
            
            try {
                const response = await fetch('/api/guestbook/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        visitorName: name,
                        visitorPhone: phone,
                        content: content
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('messageContent').value = '';
                    updateCharacterCount();
                    
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    showFormMessage('ç•™è¨€å‘å¸ƒæˆåŠŸï¼', 'success');
                    
                    // é‡æ–°åŠ è½½ç•™è¨€åˆ—è¡¨
                    loadMessages();
                } else {
                    showFormMessage(data.message || 'å‘å¸ƒç•™è¨€å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            } catch (error) {
                console.error('å‘å¸ƒç•™è¨€é”™è¯¯:', error);
                showFormMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }
        
        // æ˜¾ç¤ºè¡¨å•æ¶ˆæ¯
        function showFormMessage(text, type) {
            const messageElement = document.getElementById('formMessage');
            messageElement.textContent = text;
            messageElement.className = `form-message ${type}`;
            messageElement.style.display = 'block';
            
            // 5ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                messageElement.style.display = 'none';
            }, 5000);
        }
        
        // åŠ è½½ç•™è¨€åˆ—è¡¨
        async function loadMessages() {
            showLoading(true);
            
            try {
                const response = await fetch('/api/guestbook/messages');
                const data = await response.json();
                
                if (response.ok && data.success) {
                    displayMessages(data.messages);
                    updateMessageCount(data.messages.length);
                } else {
                    console.error('åŠ è½½ç•™è¨€å¤±è´¥:', data.message);
                    showEmptyMessages();
                }
            } catch (error) {
                console.error('åŠ è½½ç•™è¨€é”™è¯¯:', error);
                showEmptyMessages();
            } finally {
                showLoading(false);
            }
        }
        
        // æ˜¾ç¤ºç•™è¨€åˆ—è¡¨
        function displayMessages(messages) {
            const messageList = document.getElementById('messageList');
            const emptyMessages = document.getElementById('emptyMessages');
            const loadingMessages = document.getElementById('loadingMessages');
            
            // ç§»é™¤åŠ è½½æç¤º
            if (loadingMessages) {
                loadingMessages.remove();
            }
            
            if (!messages || messages.length === 0) {
                showEmptyMessages();
                return;
            }
            
            emptyMessages.style.display = 'none';
            
            // æŒ‰æ—¶é—´å€’åºæ’åºï¼ˆæœ€æ–°çš„åœ¨ä¸Šé¢ï¼‰
            messages.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            messageList.innerHTML = '';
            
            messages.forEach(message => {
                const messageCard = createMessageCard(message);
                messageList.appendChild(messageCard);
            });
        }
        
        // åˆ›å»ºç•™è¨€å¡ç‰‡
        function createMessageCard(message) {
            const card = document.createElement('div');
            card.className = 'message-card';
            
            const date = new Date(message.createdAt);
            const formattedDate = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
            
            // åˆ›å»ºå¤´åƒï¼ˆä½¿ç”¨è®¿å®¢å§“åçš„ç¬¬ä¸€ä¸ªå­—ç¬¦ï¼‰
            const avatarChar = message.visitorName ? message.visitorName.charAt(0).toUpperCase() : 'è®¿';
            
            card.innerHTML = `
                <div class="message-header">
                    <div class="message-info">
                        <div class="message-avatar">${avatarChar}</div>
                        <div>
                            <div class="message-name">${message.visitorName || 'åŒ¿åè®¿å®¢'}</div>
                            <div class="message-contact">${message.visitorPhone || ''}</div>
                        </div>
                    </div>
                    <div class="message-time">${formattedDate}</div>
                </div>
                <div class="message-content">${escapeHtml(message.content)}</div>
            `;
            
            return card;
        }
        
        // æ˜¾ç¤ºç©ºç•™è¨€æç¤º
        function showEmptyMessages() {
            const messageList = document.getElementById('messageList');
            const emptyMessages = document.getElementById('emptyMessages');
            const loadingMessages = document.getElementById('loadingMessages');
            
            // ç§»é™¤åŠ è½½æç¤º
            if (loadingMessages) {
                loadingMessages.remove();
            }
            
            messageList.innerHTML = '';
            emptyMessages.style.display = 'block';
            updateMessageCount(0);
        }
        
        // æ›´æ–°ç•™è¨€æ•°é‡
        function updateMessageCount(count) {
            document.getElementById('messageCount').textContent = `å…± ${count} æ¡ç•™è¨€`;
        }
        
        // æ˜¾ç¤º/éšè—åŠ è½½é®ç½©
        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }
        
        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>
</html>